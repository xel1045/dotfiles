#!/bin/bash

cd ~/repositories/exolnet-ansible

set -e

# Source helpers
. $DOTFILES/shell/lib/utils

LOG_OUTPUT="$HOME/Desktop/$(date +%Y%m%d)-maxwell.exolnet.com-updates.log"

e_arrow "Update exolnet-ansible"
git up

if [ -z "$AWS_SESSION_TOKEN" ]; then
	e_error "No AWS profile is assumed" 2>&1
	exit 1
fi

if [ -d .venv ]; then
	e_arrow "Activate virtualenv"
	source .venv/bin/activate
fi

e_arrow "Update maxwell.exolnet.com"
ansible-playbook play--linux:update.yml --limit maxwell.exolnet.com -v --diff 2>&1 | tee "$LOG_OUTPUT"

e_arrow "Attach log output to Redmine issue #17609"
redmine issue:attach 17609 "$LOG_OUTPUT"

if ask_yes_no "Remove local log file?"; then
	rm -f "$LOG_OUTPUT"
fi
